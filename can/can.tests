/**
 * Unit Tests for the CAN Driver
 *
 * Authors: Michael Rouse
 */
#ifdef UNIT_TEST
#include "interface.h"
#include "../testing/framework.h"

CREATE_GROUP(CAN);


/* MOCK Can Controller */
void MOCK_FUNC(can_controller_setup, (io_pin cs_pin, io_pin int_pin, uint16_t filters[], uint16_t masks[]));
void MOCK_FUNC(can_controller_transmit, (can_message* msg));
void MOCK_FUNC(can_controller_poll, (void));




/* Test the CAN Setup Function */
TEST(CAN, setup)
{
  // Arrange
  io_pin cs_pin = 6;
  io_pin int_pin = 9;

  // Act
  can_setup(cs_pin, int_pin);

  // Assert
  TEST_ASSERT_MOCK_CALLED(can_controller_setup);
}


/* Test Receiving a Message from the CAN Drivers */
TEST(CAN, ReceiveNothing)
{
  // Arrange
  io_pin cs_pin = 6;
  io_pin int_pin = 9;

  // Act
  can_setup(cs_pin, int_pin);
  can_message* msg = can_receive();

  // Assert
  TEST_ASSERT_MOCK_CALLED(can_controller_poll);
  TEST_ASSERT_NULL(msg);
}


/* Test Receive Queue */
TEST(CAN, ReceiveQueue)
{
  // Arrange
  uint16_t i;
  uint8_t j;

  uint16_t limit = 10;

  // Act
  for (i = 0; i < limit; i++)
  {
    uint8_t buffer[8];
    for (j = 0; j < 8; j++)
      buffer[j] = i;

    can_message msg;
    msg.address = 0x500 + i;
    msg.status = CAN_OK;
    for (j = 0; j < 8; j++)
      msg.data.data_u8[j] = buffer[j];

    __can_add_to_receive_queue(&msg);
  }

  // Assert
  for (i = 0; i < limit; i++)
  {
    can_message* actual = can_receive();
    TEST_ASSERT_EQUAL(0x500 + i, actual->address);
    TEST_ASSERT_EQUAL(CAN_OK, actual->status);
    TEST_ASSERT_EQUAL(i, actual->data.data_u8[0]);
  }
}


/**
 * Tests sending a CAN Message
 */
TEST(CAN, transmit)
{
  // Arrange
  io_pin cs_pin = 6;
  io_pin int_pin = 9;

  // Act
  can_setup(cs_pin, int_pin);

  can_transmit();

  // Assert
  TEST_ASSERT_MOCK_CALLED(can_controller_transmit);
}







/* Run all of the CAN Tests */
GROUP_RUNNER(CAN)
{
  PERFORM_TEST(CAN, setup);
  PERFORM_TEST(CAN, ReceiveNothing);
  PERFORM_TEST(CAN, ReceiveQueue);
  PERFORM_TEST(CAN, transmit);
}



/* Runs before every test in the CAN Group */
GROUP_TEST_SETUP(CAN)
{
  RESET_MOCK(can_controller_setup);
  RESET_MOCK(can_controller_poll);
  RESET_MOCK(can_controller_transmit);

  /* Initialize the CAN Drivers */
  can_initialization(MOCK(can_controller_setup), MOCK(can_controller_poll), MOCK(can_controller_transmit));
}

/* Runs after every test */
GROUP_TEST_TEARDOWN(CAN)
{
}

#endif