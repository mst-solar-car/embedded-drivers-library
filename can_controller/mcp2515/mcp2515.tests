/**
 * MCP2515 Unit Tests
 *
 * Authors: Michael Rouse
 */
#ifdef UNIT_TEST
#include "mcp2515.h"
#include "../../library.h"
#include "../../testing/framework.h"

CREATE_GROUP(mcp2515);

#define BUS       SPI_BUS_1
#define CS_PIN    P2_5
#define INT_PIN   P2_6

static uint16_t filters[] = { 6, 0x100, 0x200, 0x300, 0x400, 0x500, 0x600 };
static uint16_t masks[] = { 2, 0x7FF, 0x7FF };

can_message _message;

Queue* _spi_transmit_queue;

bool forceBusy;
bool busyOnNextCall;

/* Mock spi_transmit function to verify what was sent over SPI */
uint8_t MOCK_FUNC(spi_transmit_return_nothing, (spi_bus bus, uint8_t data), {
  TEST_ASSERT_EQUAL_MESSAGE(BUS, bus, "MCP2515 is not transmitting on the specified SPI Bus");
  Queue_Push(_spi_transmit_queue, &data);

  if (forceBusy == True)
  {
    if (busyOnNextCall && data == 0x00)
      return (0x00 | BIT2); // Simulate CAN being busy

    else if (data == MCP2515_READ_STATUS_CMD)
      busyOnNextCall = True;
  }
  return 0;
});

/* Fake CAN drivers */
void MOCK_FUNC(can_receive_msg, (can_message* msg), {

});


/**
 * Custom Asserts for the MCP2515 Tests
 */
#define TEST_CAN_MOD_CALL(addr, mask, data)                                                                                       \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(MCP2515_MODIFY_CMD, _spi_transmit_queue, "Missing MCP2515_MODIFY_CMD from queue");       \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(addr, _spi_transmit_queue, "Missing address from the queue");                            \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(mask, _spi_transmit_queue, "Missing mask from the queue");                               \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(data, _spi_transmit_queue, "Missing data from the queue");


#define TEST_CAN_WRITE_CALL(addr, expected, bytes) __TEST_CAN_WRITE_CALL(addr, expected, bytes, i__##expected )
#define __TEST_CAN_WRITE_CALL(addr, expected, bytes, i)                                                                             \
          uint8_t i;                                                                                                                \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(MCP2515_WRITE_CMD, _spi_transmit_queue, "Missing MCP2515_WRITE_CMD from the queue");       \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(addr, _spi_transmit_queue, "Missing address from the queue");                              \
          for (i = 0; i < bytes; i++) TEST_ASSERT_QUEUE_NEXT_MESSAGE(expected[i], _spi_transmit_queue, "Buffer data was not what was in the Queue");

#define TEST_CAN_STATUS_CHECK()                                                 \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(MCP2515_READ_STATUS_CMD, _spi_transmit_queue, "Missing MCP2515_READ_STATUS_CMD from queue"); \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(0x00, _spi_transmit_queue, "Missing NULL transmission after Status command");

#define TEST_CAN_WRITE_TX(expected)  __TEST_CAN_WRITE_TX(expected, i__##expected);
#define __TEST_CAN_WRITE_TX(expected, i)                                         \
          uint8_t i;                                                             \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(MCP2515_LOAD_TX0_CMD, _spi_transmit_queue, "Missing MCP2515_LOAD_TX0_CMD from queue");     \
          for (i = 0; i < 13; i++) TEST_ASSERT_QUEUE_NEXT_MESSAGE(expected[i], _spi_transmit_queue, "Buffer data was not in the queue"); \
          TEST_ASSERT_QUEUE_NEXT_MESSAGE(0x80 | 0x01, _spi_transmit_queue, "Missing RTS command from queue");



/* Setup */
TEST(mcp2515, setup)
{
  // Act
  can_controller_setup(BUS, CS_PIN, INT_PIN, filters, masks);

  // Assert
  TEST_ASSERT_MOCK_CALLED(spi_transmit_return_nothing);
  TEST_ASSERT_BITS_HIGH(BIT5, P2DIR);

  // Verify the order of SPI commands
  TEST_ASSERT_QUEUE_NEXT(MCP2515_RESET_CMD, _spi_transmit_queue);

  TEST_CAN_MOD_CALL(MCP2515_CONTROL_REGISTER, 0x03, 0x00);

  uint8_t expected1[] = {0x05, 0xF8, 0x00, 0x23, 0x00, 0x00};
  TEST_CAN_WRITE_CALL(MCP2515_CNF3_REGISTER, expected1, 6);

  TEST_CAN_MOD_CALL(MCP2515_RX0_REGISTER, 0x04, 0x04);

  uint8_t expected2[] = {
    (uint8_t)(filters[1] >> 3), (uint8_t)(filters[1] << 5), 0x00, 0x00,
    (uint8_t)(filters[2] >> 3), (uint8_t)(filters[2] << 5), 0x00, 0x00,
    (uint8_t)(filters[3] >> 3), (uint8_t)(filters[3] << 5), 0x00, 0x00
  };
  TEST_CAN_WRITE_CALL(MCP2515_FILTER1_REGISTER, expected2, 12);

  uint8_t expected3[] = {
    (uint8_t)(filters[4] >> 3), (uint8_t)(filters[4] << 5), 0x00, 0x00,
    (uint8_t)(filters[5] >> 3), (uint8_t)(filters[5] << 5), 0x00, 0x00,
    (uint8_t)(filters[6] >> 3), (uint8_t)(filters[6] << 5), 0x00, 0x00
  };
  TEST_CAN_WRITE_CALL(MCP2515_FILTER2_REGISTER, expected3, 12);

  uint8_t expected4[] = {
    (uint8_t)(masks[1] >> 3), (uint8_t)(masks[1] << 5), 0x00, 0x00,
    (uint8_t)(masks[2] >> 3), (uint8_t)(masks[2] << 5), 0x00, 0x00
  };
  TEST_CAN_WRITE_CALL(MCP2515_MASK_REGISTER, expected4, 8);

  TEST_CAN_MOD_CALL(MCP2515_CONTROL_REGISTER, 0xE0, 0x00);

  TEST_ASSERT_QUEUE_EMPTY(_spi_transmit_queue);
}


/* Message transmission */
TEST(mcp2515, transmit)
{
  // Arrange
  uint8_t i;

  _message.address = 0x666;
  _message.status = CAN_OK;
  for (i = 0; i < 8; i++) _message.data.data_u8[i] = i + 1;

  // Act
  can_controller_transmit(&_message);

  // Assert
  TEST_ASSERT_MOCK_CALLED(spi_transmit_return_nothing);
  TEST_CAN_STATUS_CHECK();

  uint8_t expected[] = {
    (uint8_t)(_message.address >> 3),
    (uint8_t)(_message.address << 5),
    0x00, 0x00,
    8,
    _message.data.data_u8[0],
    _message.data.data_u8[1],
    _message.data.data_u8[2],
    _message.data.data_u8[3],
    _message.data.data_u8[4],
    _message.data.data_u8[5],
    _message.data.data_u8[6],
    _message.data.data_u8[7],
  };
  TEST_CAN_WRITE_TX(expected);

  TEST_ASSERT_QUEUE_EMPTY(_spi_transmit_queue);
}



/* Run the Tests */
GROUP_RUNNER(mcp2515)
{
  _spi_transmit_queue = Queue_New(uint8_t);

  PERFORM_TEST(mcp2515, setup);
  PERFORM_TEST(mcp2515, transmit);

}


GROUP_TEST_SETUP(mcp2515)
{
  uint8_t i;

  RESET_MOCK(spi_transmit_return_nothing);
  RESET_MOCK(can_receive_msg);

  forceBusy = False;
  busyOnNextCall = False;

  /* Clear the CAN message */
  _message.address = 0x00;
  _message.status = 0x00;
  for (i = 0; i < 8; i++) _message.data.data_u8[i] = 0x00;

  __can_controller_initialization(
    MOCK(spi_transmit_return_nothing), pin_set_mode,
    pin_set_level, pin_read, interrupt_attach, MOCK(can_receive_msg)
  );
}


GROUP_TEST_TEARDOWN(mcp2515)
{
  printf("\tspi_transmit was called %i times\n\n", MOCK_CALLED_COUNT(spi_transmit_return_nothing));
}

#endif